services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${SA_PASSWORD}
      MSSQL_PID: ${MSSQL_PID:-Express}
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $$SA_PASSWORD -Q 'SELECT 1' -C || exit 1"]
      interval: 10s
      retries: 10
      start_period: 30s
      timeout: 5s

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "4317:4317"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 10s
      retries: 5
      start_period: 10s
      timeout: 5s

  rabbitmq:
    image: rabbitmq:4-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-guest}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_DEFAULT_VHOST:-/}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      retries: 10
      start_period: 30s
      timeout: 5s

  identity-api:
    image: ${DOCKER_REGISTRY:-meditrack}/identity-api:${TAG:-latest}
    build:
      context: .
      dockerfile: src/Identity.API/Dockerfile
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}

  patient-api:
    image: ${DOCKER_REGISTRY:-meditrack}/patient-api:${TAG:-latest}
    build:
      context: .
      dockerfile: src/Patient.API/Dockerfile
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__PatientDb=Server=sqlserver,1433;Database=PatientDb;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=true;
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  appointment-api:
    image: ${DOCKER_REGISTRY:-meditrack}/appointment-api:${TAG:-latest}
    build:
      context: .
      dockerfile: src/Appointment.API/Dockerfile
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__AppointmentDb=Server=sqlserver,1433;Database=AppointmentDb;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=true;
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  medicalrecords-api:
    image: ${DOCKER_REGISTRY:-meditrack}/medicalrecords-api:${TAG:-latest}
    build:
      context: .
      dockerfile: src/MedicalRecords.API/Dockerfile
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__MedicalRecordsDb=Server=sqlserver,1433;Database=MedicalRecordsDb;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=true;
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  notification-worker:
    image: ${DOCKER_REGISTRY:-meditrack}/notification-worker:${TAG:-latest}
    build:
      context: .
      dockerfile: src/Notification.Worker/Dockerfile
    environment:
      - DOTNET_ENVIRONMENT=Production
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__UserName=${RABBITMQ_DEFAULT_USER:-guest}
      - RabbitMQ__Password=${RABBITMQ_DEFAULT_PASS:-guest}
    depends_on:
      rabbitmq:
        condition: service_healthy

  web:
    image: ${DOCKER_REGISTRY:-meditrack}/web:${TAG:-latest}
    build:
      context: src/MediTrack.Web
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      - VITE_IDENTITY_URL=http://localhost:5001
      - VITE_PATIENT_API_URL=http://localhost:5002
      - VITE_APPOINTMENT_API_URL=http://localhost:5003
      - VITE_MEDICALRECORDS_API_URL=http://localhost:5004
    depends_on:
      - identity-api

volumes:
  sqlserver-data:
  rabbitmq-data:
